<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Setting a VM Custom Script Extension via Azure DevOps - reuBlog</title><meta name="description" content="Azure Custom Script Extension (CSE) provides the facilities to download and run custom PowerShell scripts on an Azure VM, using the Azure VM Agent that's installed by default on all images originating from the Microsoft Azure marketplace. It's possible to install the agent on a&hellip;"><meta name="robots" content="index, follow"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://marlinspike.github.io/setting-a-vm-custom-script-extension-via-azure-devops/"><link rel="amphtml" href="https://marlinspike.github.io/amp/setting-a-vm-custom-script-extension-via-azure-devops/"><link type="application/atom+xml" rel="alternate" href="https://marlinspike.github.io/feed.xml"><meta property="og:title" content="Setting a VM Custom Script Extension via Azure DevOps"><meta property="og:image" content="https://marlinspike.github.io/media/website/borneo.jpg"><meta property="og:site_name" content="reuBlog"><meta property="og:description" content="Azure Custom Script Extension (CSE) provides the facilities to download and run custom PowerShell scripts on an Azure VM, using the Azure VM Agent that's installed by default on all images originating from the Microsoft Azure marketplace. It's possible to install the agent on a&hellip;"><meta property="og:url" content="https://marlinspike.github.io/setting-a-vm-custom-script-extension-via-azure-devops/"><meta property="og:type" content="article"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700&amp;subset=latin-ext" rel="stylesheet"><style>h1,h2,h3,h4,h5,h6,.btn,[type=button],[type=submit],button,.navbar .navbar__menu li,.navbar_mobile_sidebar .navbar__menu li,.feed__author,.post__tag,.post__share>a span,.post__nav-link>span,.footer{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}body,h1,.h1,blockquote,.search__input,.author__name,.author__info>p,.feed__item h2,.post__nav-link{font-family:'PT Serif',Georgia,"Times New Roman",Times,serif}</style><link rel="stylesheet" href="https://marlinspike.github.io/assets/css/style.css?v=d2827d15573ecb061c72cba4248521a2"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://marlinspike.github.io/setting-a-vm-custom-script-extension-via-azure-devops/"},"headline":"Setting a VM Custom Script Extension via Azure DevOps","datePublished":"2019-05-26T19:51","dateModified":"2019-05-27T10:12","image":{"@type":"ImageObject","url":"https://marlinspike.github.io/media/website/borneo.jpg","height":540,"width":960},"description":"Azure Custom Script Extension (CSE) provides the facilities to download and run custom PowerShell scripts on an Azure VM, using the Azure VM Agent that's installed by default on all images originating from the Microsoft Azure marketplace. It's possible to install the agent on a&hellip;","author":{"@type":"Person","name":"Reuben Cleetus"},"publisher":{"@type":"Organization","name":"Reuben Cleetus","logo":{"@type":"ImageObject","url":"https://marlinspike.github.io/media/website/borneo.jpg","height":540,"width":960}}}</script><script async src="https://marlinspike.github.io/assets/js/lazysizes.min.js?v=9c0e65e25f8f098037678ba0c2be1d9f"></script></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://marlinspike.github.io/"><img src="https://marlinspike.github.io/media/website/borneo.jpg" alt="reuBlog"></a><div class="search"><div class="search__overlay js-search-overlay"><div class="search__overlay-inner"><form action="https://marlinspike.github.io/search.html" class="search__form"><input class="search__input js-search-input" type="search" name="q" placeholder="search..." autofocus="autofocus"></form><button class="search__close js-search-close" aria-label="Close">Close</button></div></div><button class="search__btn js-search-btn" aria-label="Search"><svg role="presentation" focusable="false"><use xlink:href="https://marlinspike.github.io/assets/svg/svg-map.svg#search"/></svg></button></div></header><main><article class="post"><div class="hero"><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2019-05-26T19:51">May 26, 2019</time></div><h1>Setting a VM Custom Script Extension via Azure DevOps</h1><div class="post__meta post__meta--author"><a href="https://marlinspike.github.io/authors/reuben-cleetus/" class="feed__author invert">Reuben Cleetus</a></div></div></header></div><div class="wrapper post__entry"><p>Azure Custom Script Extension (CSE) provides the facilities to download and run custom PowerShell scripts on an Azure VM, using the Azure VM Agent that's installed by default on all images originating from the Microsoft Azure marketplace. It's possible to install the agent on a custom OS Image that you bring to Azure as well.</p><p>CSE is typically configured to download scripts from Azure Blob Storage, but it can just as easily be any URI that's routable by the VM (GitHub, for example). In our discussion here, I'm going to show you how to configure and install it via Azure DevOps, and for that, there are three distinct parts to configure:</p><ul><li>Azure DevOps Pipeline - An Azure PowerShell task in the Devops Pipeline is used to call the PowerShell script to set the CSE</li><li>Blob Storage - The script itself is hosted in Blob storage, and in this case, uses <em>container</em> access level (anonymous read access)</li><li> The script itself, which runs on the VM</li></ul><p>Let's get started.</p><p> </p><p><strong>Step 1 - Prepare your script to run when the CSE is applied</strong></p><p>For my script, I've prepared a simplistic example that takes a single parameter and prints it out to a file, appropriately named "helloworld.txt", at the C:\ root. Pay attention to the name you give the file, because you'll need it later to configure the CSE. Here's the script:</p><div><div><code>param(</code></div><div><code>[parameter(Position=0,Mandatory=$false)][string]$key1="ole!"</code></div><div><code>)</code></div><br><div><code>New-Item -Path "c:\" -Name "helloworld.txt" -ItemType "file" -Value "Key1: $key1" -Force</code></div></div><p><strong>Note:</strong> The script must accept positional parameters, as shown above, and you can of course set it to a default value, as I've done.</p><p> </p><p><strong>Step 2 - Upload the script to a Container within a Storage Account</strong></p><p> Now you've got your script, but it needs to be made available to the VM when the CSE is applied. To do that, a common pattern is to upload it to a Storage Account, but you could just as well use any URI that's routable by the VM, such as GitHub.</p><figure class="post__image post__image"><img class="lazyload" src="https://marlinspike.github.io/media/posts/7/responsive/storageAccount1-xs.png" data-sizes="auto" data-srcset="https://marlinspike.github.io/media/posts/7/responsive/storageAccount1-xs.png 300w ,https://marlinspike.github.io/media/posts/7/responsive/storageAccount1-sm.png 480w ,https://marlinspike.github.io/media/posts/7/responsive/storageAccount1-md.png 768w ,https://marlinspike.github.io/media/posts/7/responsive/storageAccount1-lg.png 1024w ,https://marlinspike.github.io/media/posts/7/responsive/storageAccount1-xl.png 1360w ,https://marlinspike.github.io/media/posts/7/responsive/storageAccount1-2xl.png 1600w" alt="" width="1173" height="134"><figcaption>The scripts container in the storage account is set to Container access level</figcaption></figure><p>Here, I've uploaded the scripts to the <em>scripts</em> container within my storage account. The container is set to Container access, so that the VM can access the files without the need for a SAS token. It's entirely appropriate to use a SAS token for production use, and you should probably do that.</p><p> </p><p><strong>Step 3 - Azure DevOps Pipeline</strong></p><p>First off, we'll set up a task to run after the VM is created. In this case, as the picture below shows, there's an ARM template the runs to set up a VM, and we'll configure an Azure PowerShell task right after.</p><p>1. Search for the Azure PowerShell task in the <em>Add Tasks</em> blade, and add it to the build pipeline:</p><figure class="post__image post__image"><img class="lazyload" src="https://marlinspike.github.io/media/posts/7/responsive/pipeline3-xs.png" data-sizes="auto" data-srcset="https://marlinspike.github.io/media/posts/7/responsive/pipeline3-xs.png 300w ,https://marlinspike.github.io/media/posts/7/responsive/pipeline3-sm.png 480w ,https://marlinspike.github.io/media/posts/7/responsive/pipeline3-md.png 768w ,https://marlinspike.github.io/media/posts/7/responsive/pipeline3-lg.png 1024w ,https://marlinspike.github.io/media/posts/7/responsive/pipeline3-xl.png 1360w ,https://marlinspike.github.io/media/posts/7/responsive/pipeline3-2xl.png 1600w" alt="" width="853" height="157"><figcaption>Search for the Azure PowerShell Task and add it to the build pipeline</figcaption></figure><p>2. Once you've added the task to the pipeline, its time to conifigure the properties in the options blade, by clicking on the task.</p><figure class="post__image post__image"><img class="lazyload" src="https://marlinspike.github.io/media/posts/7/responsive/pipeline-xs.png" data-sizes="auto" data-srcset="https://marlinspike.github.io/media/posts/7/responsive/pipeline-xs.png 300w ,https://marlinspike.github.io/media/posts/7/responsive/pipeline-sm.png 480w ,https://marlinspike.github.io/media/posts/7/responsive/pipeline-md.png 768w ,https://marlinspike.github.io/media/posts/7/responsive/pipeline-lg.png 1024w ,https://marlinspike.github.io/media/posts/7/responsive/pipeline-xl.png 1360w ,https://marlinspike.github.io/media/posts/7/responsive/pipeline-2xl.png 1600w" alt="DevOps pipeline" width="637" height="280"><figcaption>DevOps pipeline</figcaption></figure><p> </p><p>Pay attention below to the <em>Inline Script </em>section, where the <span style="text-decoration: underline;">Set-AzureRmVMCustomScriptExtension</span> PowerShell command is used to set a CSE on the VM, and in this case, it's called "test-script". Note that you can only have a single CSE attached to a VM; attaching a second throws an error. You can re-attach any other PowerShell to the VM, as long as you use the same <em>-Name </em>parameter, so that the script simply installs on top of itself.</p><p>Here's the customizations I made in DevOps for the Azure PowerShell Task:</p><figure class="post__image post__image"><img class="lazyload" src="https://marlinspike.github.io/media/posts/7/responsive/pipeline2-xs.png" data-sizes="auto" data-srcset="https://marlinspike.github.io/media/posts/7/responsive/pipeline2-xs.png 300w ,https://marlinspike.github.io/media/posts/7/responsive/pipeline2-sm.png 480w ,https://marlinspike.github.io/media/posts/7/responsive/pipeline2-md.png 768w ,https://marlinspike.github.io/media/posts/7/responsive/pipeline2-lg.png 1024w ,https://marlinspike.github.io/media/posts/7/responsive/pipeline2-xl.png 1360w ,https://marlinspike.github.io/media/posts/7/responsive/pipeline2-2xl.png 1600w" alt="" width="849" height="952"><figcaption>Azure PowerShell task options</figcaption></figure><p>Here's the full inline script:</p><p><code>Set-AzureRmVMCustomScriptExtension -ResourceGroupName "astadia-dev" -Location "usgovvirginia" -VMName "vm-imds-0" -Name "test-script" -TypeHandlerVersion "1.1" -StorageAccountName $(storageAccountName) -StorageAccountKey $(storageAccountKey) -FileName "helloworld_vm_0.ps1" -ContainerName $(containerName) -Run "helloworld_vm_0.ps1" -Argument "Hello_From_DevOps!" </code></p><p>What all the parameters mean:</p><ul><li>Location - This is the region where your VM is deployed. In my case, it's usgovvirginia</li><li>VMName - The name of your VM</li><li>Name - That's the name you'll use to identify the CSE when it's attached to your VM. You can see this in the Portal by clicking on the <em>Extensions</em> item in the VM blade</li><li>StorageAccountName - The storage account where your script(s) are uploaded</li><li>FileName - One or more files (comma separated), which the CSE should download to your VM</li><li>FileName - This is the file to execute when the CSE runs. There can only be a single executable file.</li><li>Argument - The argument to pass to your script. If you'd like to pass multiple parameters, list them in a comma separated string without any spaces, and split the string in your script.</li></ul><p>It's important to remember that a CSE runs a script just one, at the time of binding. In doing so, it downloads all the files specified by the <em>-FileName</em> parameter. In this case, I've only listed one file, but you can have as many comma separated files as you'd like, and they'd all get downloaded to the VM before the file specified by the <em>-Run</em> command gets run. That file is the single entry point to the CSE.</p><p> </p><p><strong>Step 4 - Run the pipeline</strong></p><p>Running the pipeline sets the CSE, which downloads the files(s) you configured to the VM. If all goes well, your pipeline execution should succeed, and if you navigate to the VM blade in the Portal and select <em>Extensions</em>, you should see your script applied on the VM.</p><p> </p><p><strong>Step 4 - Validate that the script ran</strong></p><p>At the Portal, select the VM, and then the <em>Extensions</em> menu item on the VM blade. You should see your CSE applied, as shown below:</p><figure class="post__image post__image"><img class="lazyload" src="https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded-xs.png" data-sizes="auto" data-srcset="https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded-xs.png 300w ,https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded-sm.png 480w ,https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded-md.png 768w ,https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded-lg.png 1024w ,https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded-xl.png 1360w ,https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded-2xl.png 1600w" alt="" width="1115" height="366"><figcaption>Custom Script Extension provisioning succeeded </figcaption></figure><p>Now RDP into the VM, open File Explorer, and check the C:\ root, and you should see a file called <em>helloworld.txt</em>, which was created by the script when it ran.</p><figure class="post__image post__image"><img class="lazyload" src="https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded2-xs.png" data-sizes="auto" data-srcset="https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded2-xs.png 300w ,https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded2-sm.png 480w ,https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded2-md.png 768w ,https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded2-lg.png 1024w ,https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded2-xl.png 1360w ,https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded2-2xl.png 1600w" alt="" width="767" height="233"><figcaption>Filesystem on target VM shows the file created</figcaption></figure><p>And here's what the file looks like:</p><figure class="post__image post__image"><img class="lazyload" src="https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded3-xs.png" data-sizes="auto" data-srcset="https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded3-xs.png 300w ,https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded3-sm.png 480w ,https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded3-md.png 768w ,https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded3-lg.png 1024w ,https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded3-xl.png 1360w ,https://marlinspike.github.io/media/posts/7/responsive/cseSucceeded3-2xl.png 1600w" alt="" width="269" height="104"><figcaption>File Created by CSE</figcaption></figure></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on May 27, 2019</p><div class="post__share"></div><div class="post__bio bio"><div class="bio__info"><h3 class="bio__name"><a href="https://marlinspike.github.io/authors/reuben-cleetus/" class="invert" rel="author">Reuben Cleetus</a></h3></div></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://marlinspike.github.io/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://marlinspike.github.io/welcome-to-reublog/" class="invert post__nav-link" rel="prev"><span>Previous</span> Welcome to reuBlog</a></div></div></nav><div class="post__related related"><div class="wrapper"><h2 class="h5 related__title">You should also read:</h2><article class="related__item"><div class="feed__meta"><time datetime="2019-03-26T15:16" class="feed__date">March 26, 2019</time></div><h3 class="h1"><a href="https://marlinspike.github.io/containerize-a-dotnet-core-app-and-run-it-on-azure-web-apps/" class="invert">Containerize a Dotnet Core App, and run it on Azure Container Instances</a></h3></article><article class="related__item"><div class="feed__meta"><time datetime="2019-04-26T17:05" class="feed__date">April 26, 2019</time></div><h3 class="h1"><a href="https://marlinspike.github.io/create-a-failover-group-and-add-an-azure-sql-db-to-it/" class="invert">Create a Failover Group and add an Azure SQL DB to it</a></h3></article><article class="related__item"><div class="feed__meta"><time datetime="2019-01-05T18:02" class="feed__date">January 5, 2019</time></div><h3 class="h1"><a href="https://marlinspike.github.io/run-azure-cli-from-a-docker-image/" class="invert">Run Azure CLI from a Docker image</a></h3></article></div></div></main><footer class="footer"><div class="footer__copyright">Powered by <a href="https://getpublii.com" target="_blank" rel="nofollow noopener noreferrer">Publii Static void main(CMS</a>)</div><button class="footer__bttop js-footer__bttop" aria-label="Back to top"><svg><title>Back to top</title><use xlink:href="https://marlinspike.github.io/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="https://marlinspike.github.io/assets/js/scripts.min.js?v=f56b13ba141d95ea2a0b7aab75ca9528"></script><script>var lazyFeaturedImage=function lazyFeaturedImage(){var b=document.querySelectorAll(".hero__image-img");for(var a=0;a<b.length;a++){var c=b[a];c.addEventListener("lazyloaded",function(f){var d=f.target.parentNode;d.classList.add("hero__image--overlay")})}};lazyFeaturedImage();</script></body></html>